name: Full Test Suite

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'integration'
        type: choice
        options:
        - integration
        - e2e
        - performance
        - all

jobs:
  comprehensive-test:
    name: Comprehensive Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout source
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@194d461b21b6c5717c722ffc597fa91ed2ff29fa # v0.9.1
        with:
          pixi-version: v0.39.5

      - name: Create default config file
        run: |
          mkdir -p ~/.mopper
          cat <<EOF > ~/.mopper/user.yml
          creator_name: "CI Bot"
          organisation: "ACCESS-NRI"
          creator_email: "ci@example.com"
          creator_url: "https://example.com"
          EOF

      - name: List installed packages
        run: pixi list -e test

      - name: Run integration tests
        if: github.event.inputs.test_type == 'integration' || github.event.inputs.test_type == 'all'
        run: pixi run -e test pytest tests/integration -v --tb=short

      - name: Run end-to-end tests
        if: github.event.inputs.test_type == 'e2e' || github.event.inputs.test_type == 'all'
        run: pixi run -e test pytest tests/e2e -v --tb=short

      - name: Run performance tests
        if: github.event.inputs.test_type == 'performance' || github.event.inputs.test_type == 'all'
        run: pixi run -e test pytest tests/performance -v --tb=short

      - name: Generate coverage report (if running all tests)
        if: github.event.inputs.test_type == 'all'
        run: pixi run -e test pytest tests --cov=access_mopper --cov-report=xml --cov-report=html

      - name: Upload coverage artifacts
        if: github.event.inputs.test_type == 'all'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-report
          path: htmlcov/
